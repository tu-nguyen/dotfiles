#!/usr/bin/env bash
# ===================================================================== #
# BASH MOTD
# ===================================================================== #

# ------------------------------------------
# Display a message of the day (MOTD) when starting a new terminal session
# ------------------------------------------
# MOTD display header aka short
short_motd() {
    echo -e "${MOTD_F} ------ $OS_TYPE ------ ${NC}"

    local USER=$(whoami | tr '[:upper:]' '[:lower:]')
    local HOSTNAME=$(hostname | tr '[:upper:]' '[:lower:]')
    local LEFT_TEXT="${USER}@${HOSTNAME}"

    # print date in "Friday, 2025-06-05" format
    # print time in "Time: 17:32:08" format
    local DATE=$(date '+%a %Y/%m/%d' | tr '[:upper:]' '[:lower:]')
    local TIME=$(date '+%H:%M:%S')
    local RIGHT_TEXT=${DATE}

    local TERMWIDTH=$(tput cols)
    local PADDING_SIZE=$(( (TERMWIDTH / 4) - ${#LEFT_TEXT} - ${#RIGHT_TEXT} ))
    local SPACES=$(printf '%*s' "$PADDING_SIZE" "")

    echo -e "${BOLD}${MOTD_F}${USER}${WHITE}@${MOTD_F}${BOLD}${HOSTNAME}${SPACES}${DATE}${NC}"
    # echo -e "${${MOTD_F}}date:   ${NC}${DATE}"
    # echo -e "${${MOTD_F}}Time:    ${NC}${TIME}"  # Comment out since we always display time
}

# MOTD display rest
long_motd() {
    # System standard
    local USER=$(whoami | tr '[:upper:]' '[:lower:]')

    # User info (Mac/Linux compatibility: getent is rare on Mac)
    if command -v getent >/dev/null; then
        local FULLNAME=$(getent passwd "$USER" | cut -d: -f5 | cut -d, -f1 | tr '[:upper:]' '[:lower:]')
    else
        local FULLNAME=$(id -P "$USER" | cut -d: -f8 | tr '[:upper:]' '[:lower:]')  # Mac fallback
    fi

    # Shell Info
    local SHELL_NAME=$(basename "$SHELL")
    # Note: $SHELL --version works differently for zsh/bash
    local SHELL_VER="${BASH_VERSION%%(*)}"
    local SHELL_DISPLAY="${SHELL_NAME} ${SHELL_VER}"

    # Os & architecture
    local ARCH=$(uname -m | tr '[:upper:]' '[:lower:]')
    if [ -f /etc/os-release ]; then
        local OS_BASE=$(source /etc/os-release && echo "$PRETTY_NAME" | tr '[:upper:]' '[:lower:]')
    else
        local OS_BASE=$(uname -s | tr '[:upper:]' '[:lower:]') # Mac fallback
    fi

    # wsl specific logic
    if grep -qi Microsoft /proc/version 2>/dev/null; then
        local WIN_MAJOR=$(cmd.exe /c "ver" 2>/dev/null | grep -oP 'Version \K\d+')
        local OS="${OS_BASE} on windows ${WIN_MAJOR} ${ARCH}"
    else
        local OS="$OS_BASE"
    fi

    # Hardware & performance
    local HOSTNAME=$(hostname | tr '[:upper:]' '[:lower:]')
    if [[ "$(uname)" == "Darwin" ]]; then
        # macos: Extract uptime from the standard string using sed
        local UPTIME=$(uptime | sed -E 's/^.*up +([^,]+),.*$/\1/' | tr '[:upper:]' '[:lower:]')
    else
        # linux: use the pretty flag
        local UPTIME=$(uptime -p | sed 's/up //' | tr '[:upper:]' '[:lower:]')
    fi
    local LOAD=$(uptime | awk -F'load average:' '{ print $2 }' | sed 's/,//g' | xargs)
    local IP_ADDRESS=$(hostname -I 2>/dev/null | awk '{print $1}' || ip addr show | grep -oP 'inet \K[\d.]+' | head -n 1)
    local KERNEL=$(uname -r | tr '[:upper:]' '[:lower:]')
    local DISK_ROOT=$(df -h / | tail -1 | awk '{print $5}')

    # # Memory (macos uses 'vm_stat', linux uses 'free')
    # if command -v free >/dev/null; then
    #     local MEM_INFO=$(free -m | awk '/Mem:/ { print $3 "mib / " $2 "mib" }')
    # else
    #     local MEM_INFO="N/A (mac)"
    # fi
    # Memory (macos uses 'vm_stat', linux uses 'free')
    if command -v free >/dev/null; then
        local MEM_INFO=$(free -m | awk '/Mem:/ {
            total=$2;
            available=$7;
            used_actual=total-available;
            pct=(used_actual/total)*100;
            printf "%dMiB / %dMiB (%d%%)", used_actual, total, pct
        }')
    else
        local MEM_INFO="N/A (mac)"
    fi

    # if command -v df >/dev/null; then
    #     local DISK_INFO=$(df -Ph / | awk 'NR==2 {
    #         used=$3;
    #         total=$2;
    #         pct=$5;
    #         printf "%s / %s (%s)", used, total, pct
    #     }')
    # else
    #     local DISK_INFO="N/A"
    # fi
    DISK_INFO=$(df -Ph / | awk 'NR==2 { printf "%s / %s (%s)", $3, $2, $5 }')

    # CPU logic
    local CPU_CORES=$(nproc 2>/dev/null || sysctl -n hw.ncpu)
    if [ -f /proc/cpuinfo ]; then
        local CPU_MODEL=$(grep 'model name' /proc/cpuinfo | head -1 | cut -d ':' -f 2 | xargs | tr '[:upper:]' '[:lower:]')
        local CPU_SPEED_MHZ=$(wmic.exe cpu get MaxClockSpeed 2>/dev/null | tail -n +2 | tr -d '\r' | xargs)
        if [ -n "$CPU_SPEED_MHZ" ]; then
            local CPU_GHZ=$(echo "$CPU_SPEED_MHZ" | awk '{printf "%.3f", $1/1000}')
            local CPU="${CPU_MODEL} (${CPU_CORES}) @ ${CPU_GHZ}ghz"
        else
            local CPU="${CPU_MODEL} (${CPU_CORES})"
        fi
    else
        local CPU=$(sysctl -n machdep.cpu.brand_string | tr '[:upper:]' '[:lower:]') # macos fallback
    fi

    # Misc
    local LAST_LOGIN=$(last -n 1 $USER | head -n 1 | awk '{ print $5, $6, $7 }')
    local RECENT_LOGINS=$(last -n 5 | awk '{print $1, $3, $5, $6, $7}')
    local LAST_COMMANDS=$(history | tail -n 5 | awk '{print $2, $3, $4, $5, $6, $7}')
    local LAST_SHUTDOWN

    if [[ "$(uname)" == "Darwin" ]]; then
        # macos: 'last shutdown' works without -x.
        # We grab the first line and pick the relevant date columns.
        LAST_SHUTDOWN=$(last shutdown | head -n 1 | awk '{print $3, $4, $5, $6}')

        # If 'last shutdown' is empty (common on some macos), check 'reboot'
        if [[ -z "$LAST_SHUTDOWN" ]]; then
            LAST_SHUTDOWN=$(last reboot | head -n 1 | awk '{print $3, $4, $5, $6}')
        fi
    else
        # linux: uses -x to show shutdown events
        LAST_SHUTDOWN=$(last -x shutdown | head -n 1 | awk '{print $5, $6, $7, $8}')
    fi

    # echo -e "${BOLD}${MOTD_F}${USER}${WHITE}@${BOLD}${MOTD_F}${HOSTNAME}${NC}"
    echo -e "${WHITE}------------------------------------------${NC}"
    echo -e "${MOTD_F}os:     ${NC}${OS}"
    echo -e "${MOTD_F}kernel: ${NC}${KERNEL}"
    echo -e "${MOTD_F}uptime: ${NC}${UPTIME}"
    echo -e "${MOTD_F}shell:  ${NC}${SHELL_DISPLAY}"
    echo -e "${MOTD_F}cpu:    ${NC}${CPU}"
    echo -e "${MOTD_F}memory: ${NC}${MEM_INFO}"
    echo -e "${MOTD_F}disk /: ${NC}${DISK_INFO}"
}

motd() {
    if [ -z "$DOTFILES_CONFIG_DIR" ]; then
        DOTFILES_CONFIG_DIR="$HOME/.config/dotfiles"
        printf "${WARN}[ WARN ]${NC} DOTFILES_CONFIG_DIR is not set, defaulting to $DOTFILES_CONFIG_DIR"
    fi

    if [ "$1" == "auto" ]; then
        COOLDOWN_FILE="$DOTFILES_CONFIG_DIR/.okfetch_last_run_${USER}"
        CURRENT_TIME=$(date +%s)
        COOLDOWN_TIME=1169

        if [ -f "$COOLDOWN_FILE" ]; then
            LAST_RUN=$(qat "$COOLDOWN_FILE")
            ELAPSED=$((CURRENT_TIME - LAST_RUN))

            if [ "$ELAPSED" -lt "$COOLDOWN_TIME" ]; then
                short_motd
                if [[ $- == *i* ]] && [ -t 0 ] && command -v twork_motd >/dev/null; then
                    twork_motd
                fi
                return 0
            fi
        fi
        # Update timestamp only on auto-runs that actually display
        echo "$CURRENT_TIME" > "$COOLDOWN_FILE"
    fi
    short_motd
    long_motd
    if [[ $- == *i* ]] && [ -t 0 ] && command -v td >/dev/null; then
        td
    fi
}
