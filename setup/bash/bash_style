#!/bin/bash

if [ -n "$BASH_STYLE_LOADED" ]; then
    return 0
fi
BASH_STYLE_LOADED=1

# Color Support Detection
if [[ "$COLORTERM" == "truecolor" || "$COLORTERM" == "24bit" ]]; then
    COLOR_MODE="hex"
elif [[ "$TERM" == *"256color"* ]]; then
    COLOR_MODE="256"
else
    COLOR_MODE="basic"
fi

# Function to convert hex to 0-5 scale for ANSI cube
# Same as the one in utils.sh
_hex_to_256() {
    # Remove leading # if it exists
    local hex="${1#\#}"

    # Extract R, G, B pairs
    local r_hex="${hex:0:2}"
    local g_hex="${hex:2:2}"
    local b_hex="${hex:4:2}"

    # Convert hex to decimal (base 16)
    local r=$((16#$r_hex))
    local g=$((16#$g_hex))
    local b=$((16#$b_hex))

    # Calculate the 256-color cube index
    # (Safe math for all Bash versions)
    if [ "$r" -eq "$g" ] && [ "$g" -eq "$b" ]; then
        echo $(( 232 + (r * 23) / 255 ))
    else
        echo $(( 16 + (36 * (r * 5 / 255)) + (6 * (g * 5 / 255)) + (b * 5 / 255) ))
    fi
}

# Function to set Foreground
_set_fg() {
    local hex_in=$1; local basic=$2
    local hex="${hex_in#\#}" # Strip #

    # Apple Terminal (Force 256)
    if [[ "$TERM_PROGRAM" == "Apple_Terminal" ]]; then
        echo -ne "\033[38;5;$(_hex_to_256 "$hex")m"

    # 256 Mode
    elif [[ "$COLOR_MODE" == "256" ]]; then
        echo -ne "\033[38;5;$(_hex_to_256 "$hex")m"

    # Hex Mode
    elif [[ "$COLOR_MODE" == "hex" ]]; then
        local r=$((16#${hex:0:2}))
        local g=$((16#${hex:2:2}))
        local b=$((16#${hex:4:2}))
        echo -ne "\033[38;2;${r};${g};${b}m"

    # Fallback to Standard ANSI
    else
        tput setaf "$basic" 2>/dev/null || echo -ne "\033[3${basic}m"
    fi
}

# Set to set Background
_set_bg() {
    local hex_in=$1; local basic=$2
    local hex="${hex_in#\#}" # Strip #

    if [[ "$TERM_PROGRAM" == "Apple_Terminal" ]]; then
        echo -ne "\033[48;5;$(_hex_to_256 "$hex")m"
    elif [[ "$COLOR_MODE" == "256" ]]; then
        echo -ne "\033[48;5;$(_hex_to_256 "$hex")m"
    elif [[ "$COLOR_MODE" == "hex" ]]; then
        local r=$((16#${hex:0:2}))
        local g=$((16#${hex:2:2}))
        local b=$((16#${hex:4:2}))
        echo -ne "\033[48;2;${r};${g};${b}m"
    else
        tput setab "$basic" 2>/dev/null || echo -ne "\033[4${basic}m"
    fi
}

# Text Colors (Foreground)
BLACK=$(_set_fg '#282828' 0)
RED=$(_set_fg '#cc241d' 1)
GREEN=$(_set_fg '#689d6a' 2)
YELLOW=$(_set_fg '#d79921' 3)
BLUE=$(_set_fg '#0000ff' 4)
MAGENTA=$(_set_fg '#b16286' 5)
CYAN=$(_set_fg '#00ffff' 6)
WHITE=$(_set_fg '#ffffff' 7)
GRAY=$(_set_fg '#928374' 8)
PINK=$(_set_fg '#ffc0cb' 5) # Fallback to Magenta if no pink available
LIGHT_PINK=$(_set_fg '#ffb6C1' 217)  # Soft, light rose
DARK_PINK=$(_set_fg '#e75480' 168)   # Deep, punchy rose
HOT_PINK=$(_set_fg '#ff10f0' 201)   # High-contrast "Neon" pink
PASTEL_PINK=$(_set_fg '#ffd1dc' 224) # Very soft, creamy pink

# Bright Colors (if your terminal supports them)
BRIGHT_RED=$(_set_fg '#fb4934' 9)
BRIGHT_GREEN=$(_set_fg '#b8bb26' 10)
BRIGHT_YELLOW=$(_set_fg '#fabd2f' 11)
BRIGHT_BLUE=$(_set_fg '#83a598' 12)
BRIGHT_MAGENTA=$(_set_fg '#d3869b' 13)
BRIGHT_CYAN=$(_set_fg '#41fdfe' 14)

# Background
ON_BLACK=$(_set_bg '#282828' 0)
ON_RED=$(_set_bg '#cc241d' 1)
ON_GREEN=$(_set_bg '#689d6a' 2)
ON_YELLOW=$(_set_bg '#d79921' 3)
ON_BLUE=$(_set_bg '#0000ff' 4)
ON_MAGENTA=$(_set_bg '#b16286' 5)
ON_CYAN=$(_set_bg '#00ffff' 6)
ON_WHITE=$(_set_bg '#ffffff' 7)
ON_PINK=$(_set_bg '#ffc0cb' 5)
ON_BRIGHT_RED=$(_set_bg '#fb4934' 9)
ON_BRIGHT_GREEN=$(_set_bg '#b8bb26' 10)
ON_BRIGHT_YELLOW=$(_set_bg '#fabd2f' 11)
ON_BRIGHT_BLUE=$(_set_bg '#83a598' 12)
ON_BRIGHT_MAGENTA=$(_set_bg '#d3869b' 13)
ON_BRIGHT_CYAN=$(_set_bg '#41fdfe' 14)

# Formatting
BOLD=$(tput bold 2>/dev/null || echo -e '\033[1m')
UNDERLINE=$(tput smul 2>/dev/null || echo -e '\033[4m')
RESET=$(tput sgr0 2>/dev/null || echo -e '\033[0m')
NC=$RESET

# Status
OK="${GREEN}${BOLD}"
SUCCESS="${BOLD}${GREEN}"
INFO="${BOLD}${PINK}"
WARN="${BOLD}${YELLOW}"
ERR="${BOLD}${RED}"
DEBUG="${MAGENTA}"
ALERT="${BOLD}${WHITE}${ON_RED}"  # Bold White on red background

# Structure Styles
HDR_F="${BOLD}${PINK}"  # Main header s
SUB_F="${BOLD}${CYAN}"  # Secondary headers
KEY_F="${PINK}"  # Labels/Keys
VAL_F="${WHITE}"  # Data values
DIM_F="${GRAY}"  # Secondary/Dimmed text
SEP_F="${GRAY}"  # Separator
SEL_F="${BOLD}${WHITE}"  # Selection/Choice

# Other
NOTICE_F="${BOLD}${ON_BLUE}${WHITE}" # Attention-grabbing banners
URL_F="${UNDERLINE}${BLUE}" # Links

# Backward compat with my old Makefile/settings
H="${HDR_F}"
H2="${SUB_F}"
S="${KEY_F}"
S2="${VAL_F}"

# Example usage
# echo "${RED}This is red text${NC}"
# echo "${BOLD}${WHITE}This is bold edwhite text ${NC}"
# echo "${BLUE}${ON_PURPLE}This is blue text on purple background${NC}"

if [[ "$OSTYPE" == "macos"* ]]; then
    MOTD_F="${MAGENTA}"
elif [[ "$OSTYPE" == "wsl" ]]; then
    MOTD_F="${PINK}"
else
    MOTD_F="${PASTEL_PINK}"
fi

# Theme switcher
set_theme() {
    local theme=$1

    case $theme in
        "main")
            _P_MAIN='#ffc0cb' # Pink
            _P_SUB='#00ffff'  # Aqua/Cyan
            _P_ACCENT='#ffd1dc' # Pastel
            echo "Mood: Cyberpunk active."
            ;;
        "cyber")
            _P_MAIN='#ff10f0' # Neon Pink
            _P_SUB='#00ffff'  # Aqua/Cyan
            _P_ACCENT='#ffd1dc' # Pastel
            echo "Mood: Cyberpunk active."
            ;;
        "nord")
            _P_MAIN='#88c0d0' # Frost Blue
            _P_SUB='#81a1c1'  # Arctic Blue
            _P_ACCENT='#d8dee9' # Snow White
            echo "Mood: Arctic chill active."
            ;;
        "dracula")
            _P_MAIN='#bd93f9' # Purple
            _P_SUB='#50fa7b'  # Green
            _P_ACCENT='#ff79c6' # Pink
            echo "Mood: Vampire mode."
            ;;
        "monokai")
            _P_MAIN='#f92672'   # Vivid Pink
            _P_SUB='#a6e22e'    # Bright Green
            _P_ACCENT='#66D9ef' # Sky Blue
            echo "Mood: Classic pro mode."
            ;;
        "forest")
            _P_MAIN='#2d5a27'   # Deep Pine
            _P_SUB='#9bc693'    # Sage
            _P_ACCENT='#e9ffdb' # Off-white
            echo "Mood: Woodland focus."
            ;;
        "tokyo-night")
            _P_MAIN='#7aa2f7'   # Storm Blue
            _P_SUB='#bb9af7'    # Magenta/Purple
            _P_ACCENT='#c0caf5' # Soft Silver
            echo "Mood: Tokyo neon lights."
            ;;
        "matrix")
            _P_MAIN='#00ss41'   # Matrix Green
            _P_SUB='#003b00'    # Dark Green
            _P_ACCENT='#0Dd0208' # Black
            echo "Mood: Wake up, Neo."
            ;;
        *)
            echo "Usage: set_theme [main|cyber|nord|dracula|monokai|forest|tokyo-night|matrix]"
            return 1
            ;;
    esac

    # Re-assign the core colors using your set_fg helper
    PINK=$(_set_fg "$_P_MAIN" 5)
    CYAN=$(_set_fg "$_P_SUB" 6)
    PASTEL_PINK=$(_set_fg "$_P_ACCENT" 7)

    # Refresh the UI Presets
    HDR_F="${BOLD}${PINK}"
    SUB_F="${BOLD}${CYAN}"
    KEY_F="${PINK}"
    H="${HDR_F}"
    H2="${SUB_F}"
}

# Color Verification Test
color_test() {
    echo -e "${BOLD}Current Mode:${NC} $COLOR_MODE (TERM: $TERM)\n"
    echo -e "${BOLD}Primary Colors: ${NC}${PINK}PINK ${RED}RED ${GREEN}GREEN ${YELLOW}YELLOW ${BLUE}BLUE ${MAGENTA}MAGENTA ${CYAN}CYAN ${WHITE}WHITE ${GRAY}GRAY ${NC}\n"
    echo -e "${BOLD}Bright Colors: ${NC}${PASTEL_PINK}PASTEL_PINK ${BRIGHT_RED}B_RED ${BRIGHT_GREEN}B_GREEN ${BRIGHT_YELLOW}B_YELLOW ${BRIGHT_BLUE}B_BLUE ${BRIGHT_MAGENTA}B_MAGENTA ${BRIGHT_CYAN}B_CYAN\n"
    echo -e "${BOLD}Backgrounds: ${NC}${ON_PINK}ON_PINK${NC} ${ON_RED}ON_RED${NC} ${ON_GREEN}ON_GREEN${NC} ${ON_YELLOW}ON_YELLOW${NC} ${ON_BLUE}ON_BLUE${NC} ${ON_MAGENTA}ON_MAGENTA${NC} ${ON_CYAN}ON_CYAN${NC} ${ON_WHITE}ON_WHITE${NC}\n"
    echo -e "${BOLD}Current Setting:${NC}"
    echo -e "${OK}OK         ${HDR_F}HDR_F${NC}         ${H}H${NC}"
    echo -e "${SUCCESS}SUCCESS${NC}    ${SUB_F}SUB_F${NC}         ${H2}H2${NC}"
    echo -e "${INFO}INFO${NC}       ${KEY_F}KEY_F${NC}         ${S}S${NC}"
    echo -e "${WARN}WARN${NC}       ${VAL_F}VAL_F${NC}         ${S2}S2${NC}"
    echo -e "${ERR}ERR${NC}        ${DIM_F}DIM_F${NC}         ${NOTICE_F}NOTICE_F${NC}"
    echo -e "${DEBUG}DEBUG${NC}      ${SEP_F}SEP_F${NC}         ${URL_F}URL_F${NC}"
    echo -e "${ALERT}ALERT${NC}      ${SEL_F}SEL_F${NC}"
}
