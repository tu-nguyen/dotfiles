#!/usr/bin/env bash
# ========================================== #
#
# #

# TODO add comments later
# ========================================== #

# ------------------------------------------
# Pre-flight checks & Shell options
# ------------------------------------------

# Guard: If not running interactively, don't do anything to avoid breaking non-interactive scripts
[[ $- != *i* ]] && return

# Input/Output behavior
set -o vi                           # Use vi-style line editing
set -o ignoreeof                    # Prevent Ctrl-D from accidentally exiting the shell

# Shell Options (shopt)
shopt -s autocd                     # If a directory name is typed alone, cd into it
shopt -s dotglob                    # Include filenames beginning with a '.' in glob patterns
shopt -s nullglob                   # If a pattern matches nothing, expand to nothing instead of the pattern itself
shopt -s checkwinsize               # Update LINES and COLUMNS after each command if terminal size changed
shopt -s cdspell                    # Correct minor typos in directory names during 'cd'
shopt -s cdable_vars                # If an argument to 'cd' isn't a dir, assume it's a variable name
shopt -s checkhash                  # Always check if a hashed command exists before executing
shopt -s sourcepath                 # Force 'source' to use the PATH to find files
shopt -s no_empty_cmd_completion    # Don't look for commands on PATH when trying to complete an empty line
shopt -s cmdhist                    # Save multi-line commands as a single history entry
shopt -s histappend                 # Append to history file instead of overwriting
shopt -s histreedit                 # Allow user to re-edit a failed history substitution
shopt -s histverify                 # Load history substitution into the editing buffer instead of executing immediately

# Enable Programmable Completion
if ! shopt -oq posix; then
    if [ -f /usr/share/bash-completion/bash_completion ]; then
        . /usr/share/bash-completion/bash_completion
    elif [ -f /etc/bash_completion ]; then
        . /etc/bash_completion
    fi
fi

# ------------------------------------------
# Load custom bash files
# ------------------------------------------
# Dynamically loads all .bash_* files from your custom dotfiles directory (~/.config/dotfiles).
export DOTFILES_CONFIG_DIR="$HOME/.config/dotfiles"

if [[ -d "$DOTFILES_CONFIG_DIR" ]]; then

    [[ -f "$DOTFILES_CONFIG_DIR/.init" ]] && . "$DOTFILES_CONFIG_DIR/.init"

    for file in "$DOTFILES_CONFIG_DIR"/.bash_*; do
        [[ "$file" == *"/.bash_style" ]] && continue
        [[ "$file" == *"/.init" ]] && continue
        [[ -f "$file" && -r "$file" ]] && . "$file"
    done

else
    # Use your custom 't' function if available, otherwise fallback to standard echo
    if declare -f t > /dev/null; then
        t ERR "Config directory not found: $DOTFILES_CONFIG_DIR"
    else
        echo -e "\033[0;31m[ERR]\033[0m Config directory not found: $DOTFILES_CONFIG_DIR"
    fi
fi

# ------------------------------------------
# Tools & Prompt
# ------------------------------------------

# bat theme and man
# TODO: create my own?
# Further themes can be installed to '/home/valcr/.config/bat/themes', and are added to the cache with `bat cache --build`. For more information, see:
# https://github.com/sharkdp/bat#adding-new-themes
if [[ -z "$BAT_THEME" ]]; then
    export BAT_THEME='Visual Studio Dark+'
fi
export MANPAGER="bat -plman"
# export BAT_PAGER="less -RFK"

# direnv hook
if command -v direnv &> /dev/null; then
    eval "$(direnv hook bash)"
fi

# Starship Prompt: Cross-shell customizable prompt
if command -v starship &> /dev/null; then
    eval "$(starship init bash)"
fi

# Transient prompt for Starship
_starship_transient_prompt() {
    if [[ $? -eq 0 ]]; then
        printf "${OK_F}❯ ${NC}"
    else
        printf "${ERR_F}❯ ${NC}"
    fi
}

# FNM (Fast Node Manager) with 24-hour Auto-Update check
FNM_PATH="$HOME/.local/share/fnm"
if [[ -d "$FNM_PATH" ]]; then
    export PATH="$FNM_PATH:$PATH"
    eval "$(fnm env --use-on-cd --shell bash)"

    # Check for Node LTS updates once every 24 hours (86400 seconds)
    TIMESTAMP_FILE="$DOTFILES_CONFIG_DIR/.node_update_timestamp"
    CURRENT_TIME=$(date +%s)
    UPDATE_INTERVAL=86400

    if [[ ! -f "$TIMESTAMP_FILE" ]] || (( CURRENT_TIME - $(cat "$TIMESTAMP_FILE") > UPDATE_INTERVAL )); then
        # Determine latest LTS and set as default
        LTS_VER=$(fnm list | grep 'lts-latest' | awk '{print $2}')
        if [[ -n "$LTS_VER" ]]; then
            fnm default "$LTS_VER" >/dev/null
            echo "$CURRENT_TIME" > "$TIMESTAMP_FILE"
        fi
    fi
fi

# Window Title: Sets terminal tab title to "♥ CurrentDir"
set_win_title() {
    echo -ne "\033]2;♥ ${PWD##*/}\007"
}

# Update window title and maintain existing PROMPT_COMMAND logic
export PROMPT_COMMAND="set_win_title; $PROMPT_COMMAND"

# -----------------------------------------
# Greeting, motd, and colors
# ------------------------------------------

# Display the Message of the Day if the 'motd' command is available
if [[ -f "$DOTFILES_CONFIG_DIR/.bash_motd" ]]; then
    # Assuming 'motd' is a function or alias defined in your .bash_ files
    motd auto
else
    [[ $(type -t t) == "function" ]] && t WARNING "MOTD file not found at $DOTFILES_CONFIG_DIR/.bash_motd\n"
fi

unset DOTFILES_LOADED
unset BASH_STYLE_LOADED
alias now='unset DOTFILES_LOADED BASH_STYLE_LOADED && source ~/.bashrc'
